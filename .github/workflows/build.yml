name: Rolling Build - Mihomo Auto Update

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'   # â° Setiap jam 00:00 UTC (07:00 WIB)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ§± Checkout
      uses: actions/checkout@v4

    - name: ðŸ› ï¸ Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git wget curl python3

    - name: ðŸ“¥ Clone OpenWrt
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ðŸ“‚ Clone Mihomo package
      run: |
        cd openwrt/package
        git clone https://github.com/morytyann/OpenWrt-mihomo mihomo

    - name: ðŸ”„ Auto Update Mihomo Version & Hash
      run: |
        cd openwrt/package/mihomo
        # Ambil versi terbaru dari GitHub API
        LATEST=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep -Po '"tag_name": "\Kv[0-9\.]+')
        LATEST=${LATEST#v}
        echo "ðŸ“Œ Latest version: $LATEST"

        # Update PKG_VERSION
        sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$LATEST/" Makefile

        # Download tarball dan hitung hash
        TARBALL="mihomo-$LATEST.tar.gz"
        URL="https://codeload.github.com/MetaCubeX/mihomo/tar.gz/refs/tags/v$LATEST"
        echo "ðŸ“¥ Downloading $URL"
        wget -q -O "$TARBALL" "$URL"

        echo "ðŸ”‘ Calculating SHA256..."
        NEW_HASH=$(sha256sum "$TARBALL" | awk '{print $1}')
        echo "âœ… New hash: $NEW_HASH"

        # Update PKG_HASH
        sed -i "s/^PKG_HASH:=.*/PKG_HASH:=$NEW_HASH/" Makefile

        rm -f "$TARBALL"
        echo "âœ¨ Makefile updated with version $LATEST and hash $NEW_HASH"

    - name: ðŸ§° Setup build config (optional)
      run: |
        cd openwrt
        # Buat default config minimal (bisa diganti sesuai kebutuhan)
        cat >> .config <<EOF
CONFIG_PACKAGE_mihomo=y
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_Generic=y
EOF
        make defconfig

    - name: ðŸš€ Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    - name: ðŸ“¤ Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-mihomo-firmware
        path: openwrt/bin/targets
        
